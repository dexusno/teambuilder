# Generate Team Workflow Instructions

Core generation engine that creates custom AI agent teams from requirements.

## Overview

This workflow transforms user requirements into a complete, functional AI agent team with distinct personas and actionable workflows. The generation process uses pattern library examples to learn composition principles, then creates an entirely new team tailored to the user's specific needs.

**Architecture:** Generated agents follow **role-appropriate architecture** matching working BMAD agents:
- **Entry-point agents** (user-invokable) â†’ thin shell with menu + workflow delegation (~65-80 lines)
- **Sub-agents** (workflow participants) â†’ persona + focused instructions (no menu, no activation)
- **Team workflows** â†’ external step files processed by the workflow.xml engine with checkpoints

## Critical Principles

1. **LEARN from patterns, NEVER COPY** - Patterns teach principles, not templates
2. **Distinct personas are non-negotiable** - Each agent must be memorable and unique
3. **Domain expertise must be authentic** - Use terminology and context from requirements
4. **Address every key concern** - Each concern gets specialist agent
5. **Collaboration model must match user preference** - Formal, agile, consultative, etc.
6. **Thin shells for entry-points, not fat monoliths** - Task logic lives in workflow files, not agent files

---

## Step-by-Step Generation Process

<step n="1" goal="Load Requirements Document">

<action>
Load the requirements document generated by discovery workflow.
Extract all key variables for use in generation.
</action>

<extract>
- {{primary_task}} - What user needs help with
- {{domain}} - Domain classification
- {{team_size_preference}} - Desired team size (4-6, 6-8, 8-12)
- {{key_concerns}} - Array of user's main concerns
- {{collaboration_style}} - How team should work together
- {{workflow_preference}} - Workflow style (guided, flexible, structured)
- {{required_expertise}} - Must-have expertise
- {{domain_context}} - Domain-specific context
- {{domain_specific_1, 2, 3}} - Domain details
</extract>

<verification>
Confirm all required variables are present. If any are missing, cannot proceed with generation.
</verification>

</step>

---

<step n="2" goal="Load Pattern Library">

<action>
Load relevant patterns from pattern library to learn composition principles.
</action>

<pattern_selection>
Based on {{domain}} classification, load:
1. **Primary pattern**: Match domain directly
   - research-intelligence â†’ research-intelligence pattern
   - planning-strategy â†’ planning-strategy pattern
   - creative-content â†’ creative-content pattern
   - technical-development â†’ software-development pattern
   - operations-support â†’ software-development pattern (closest match)
   - domain-specific-expert â†’ itil-domain-expert pattern

2. **Secondary patterns**: Load 1-2 additional patterns for diversity
   - Always include one pattern with different team size
   - Consider one pattern with different collaboration model
</pattern_selection>

<load>
For each selected pattern, load:
- `metadata.yaml` - Pattern characteristics
- `example-agents.md` - Agent archetype examples
- `example-workflows.md` - Workflow structure examples
- `collaboration-model.md` - How agents interact
- `generation-guidance.md` - Composition principles

Store in {{loaded_patterns}} array
Store primary pattern name in {{primary_pattern}}
</load>

<context_window_optimization>
If patterns are too large for context:
- Load full primary pattern
- Load summaries of secondary patterns
- Prioritize example-agents.md and generation-guidance.md
</context_window_optimization>

</step>

---

<step n="3" goal="Study Pattern Learnings">

<action>
Analyze loaded patterns to extract composition principles.
DO NOT memorize specific agents to copy.
LEARN the principles that make them high quality.
</action>

<learn>
Study patterns for:

**1. Persona Quality Markers:**
- How do example agents have specific backgrounds? (e.g., "Former Navy officer turned Agile coach")
- What makes communication styles distinct? (e.g., uses military brevity codes vs warm storyteller vs analytical precision)
- How do principles reveal unique perspectives? (e.g., "Blockers are the enemy" vs "Every idea deserves exploration")
- What makes agents memorable? (personality markers, specific phrases, behavioral patterns)

**2. Role Composition:**
- How are roles structured? (coordinator + experts + specialists + support)
- What ensures no overlap? (distinct capabilities, clear boundaries)
- How is coverage ensured? (analysis, execution, quality/review roles present)

**3. Domain Expertise:**
- How is domain knowledge demonstrated? (terminology, context understanding, specific challenges referenced)
- Where does expertise show? (in identity, principles, communication style)

**4. Collaboration Models:**
- How do agents work together? (formal handoffs, agile ceremonies, consultative discussion)
- What defines interaction patterns? (who talks to whom, when, how)
- How are decisions made? (hierarchical, consensus, advisory)

**5. Workflow Design:**
- What makes workflows actionable? (specific steps, explicit assignments, concrete outputs)
- How are agent capabilities matched to tasks? (right agent for right step)
- What defines quality workflows? (clear goals, measurable outputs, logical flow)

</learn>

<store>
Synthesize learnings into {{pattern_learnings}} for reference during generation.
</store>

<critical>
You are extracting PRINCIPLES, not creating a library of agents to copy.
If you find yourself thinking "I'll use this pattern's research strategist agent,"
you're doing it WRONG. Instead think: "I learned that research agents should
have query refinement expertise and iterative search patterns - I'll create
a NEW agent with these principles for user's specific domain."
</critical>

</step>

---

<step n="4" goal="Define Agent Roles and Types">

<action>
Based on requirements and pattern learnings, define roles for the team.
For each role, designate it as Entry-Point or Sub-Agent type.
</action>

<role_definition>

**Required Roles:**

1. **Primary Coordinator / Decision-Maker** (Always required, always Entry-Point)
   - Orchestrates team
   - Makes final decisions or facilitates consensus
   - Matches {{collaboration_style}}
   - Examples: Project Manager, Practice Owner, Strategy Lead, Creative Director

2. **Domain Expert(s)** (1-2 required, Entry-Point if user-invokable, Sub-Agent if workflow-only)
   - Deep expertise in {{domain}}
   - Understands {{domain_context}}
   - Uses terminology from requirements
   - Examples: Technical Architect, Domain Consultant, Subject Matter Expert

3. **Specialist for Each Key Concern** (1 per concern, type depends on usage)
   - {{key_concern_1}} â†’ Specialist agent
   - {{key_concern_2}} â†’ Specialist agent
   - {{key_concern_3}} â†’ Specialist agent
   - [Additional concerns]
   - Examples: Risk Analyst, Quality Assurance, Security Specialist, Compliance Expert

4. **Support Roles** (As needed to reach team size, usually Sub-Agents)
   - Analyst or researcher
   - Documentation or communication specialist
   - Quality reviewer
   - Process coordinator
   - Examples vary by domain

</role_definition>

<type_designation>
For each agent role, determine its type:

**Entry-Point (Thin Shell)** - when the agent:
- Is a primary user-facing agent (coordinator, lead researcher, etc.)
- Has its own set of tasks the user would invoke directly
- Needs a menu with domain-specific workflow options
- Will have a command stub for slash-command invocation

**Sub-Agent (Specialist)** - when the agent:
- Primarily participates in team workflows run by other agents
- Is called during specific workflow steps, not invoked directly
- Provides expertise within a larger process
- Does NOT need its own menu or activation

**Guideline:** Most teams have 2-4 Entry-Point agents and the rest are Sub-Agents.
A 6-agent team might have: 2-3 Entry-Point + 3-4 Sub-Agent.
</type_designation>

<count_check>
Target agent count: {{team_size_preference}}

If defining roles results in:
- Too few: Add support roles that enhance team capability
- Too many: Consolidate roles where sensible (e.g., one agent covers 2 related concerns)
- Just right: Proceed

Store in {{agent_roles}} array (each with name, role, and type designation)
Store count in {{agent_count}}
Store entry-point count in {{entry_point_count}}
Store sub-agent count in {{sub_agent_count}}
</count_check>

<critical>
Every key concern MUST be addressed by an agent. This is non-negotiable.
If user said "risk management" is a concern, team MUST have risk management specialist.
</critical>

</step>

---

<step n="5" goal="Generate Agent Personas">

<action>
For each role defined in step 4, create a complete, distinct persona.
This is the most critical step for quality.
Both Entry-Point and Sub-Agent types need equally rich personas.
</action>

<generation_process>

For each agent role:

**1. Create Role Description**
- Be specific about capabilities
- Include domain context
- Mention key expertise area
- 1-2 sentences

Example:
Bad: "Project manager who coordinates teams"
Good: "Sprint Orchestrator who demolishes blockers and ensures velocity through military-precision coordination and relentless follow-through"

**2. Create Identity (Background & Expertise)**
- Give SPECIFIC background (not "experienced professional")
- Include relevant credentials or achievements
- Add personality through details
- 3-5 sentences

Example:
Bad: "Experienced project manager with background in Agile methodologies"
Good: "Former Navy logistics officer turned Agile coach. Spent 8 years coordinating aircraft carrier operations where delays meant mission failure. Now applies military precision to software delivery. Certified Scrum Master and SAFe Program Consultant. Has successfully coached 15+ teams through transformations, with particular expertise in high-stakes, regulated environments."

**3. Create Communication Style**
- Make it DISTINCTIVE (not "professional and clear")
- Include specific patterns or phrases
- Show personality through communication
- Mention interaction preferences
- 3-4 sentences

Example:
Bad: "Professional and clear communication style. Collaborative approach."
Good: "Direct and action-oriented. Uses military brevity codes for efficiency. Starts every interaction with 'Status? Blockers? Actions?' Follows up relentlessly but never micromanages. Celebrates velocity improvements like mission successes. When something's blocked, switches to crisis mode: 'What do you need? Who do I need to talk to? Let's solve this now.'"

**4. Create Principles**
- Express as beliefs or strong opinions
- Show what they optimize for
- Reveal their perspective
- Make philosophically distinct from other agents
- 3-5 principles or 3-4 sentences

**5. Select Icon**
- Choose meaningful emoji for agent role

</generation_process>

<distinctness_requirement>

**CRITICAL: Each agent must be DRAMATICALLY DIFFERENT from others**

Vary across agents:
- Communication styles: Formal, casual, technical, warm, direct, analytical, creative
- Backgrounds: Different industries, roles, expertise areas
- Personality markers: Some agents are cautious, others bold; some detail-oriented, others big-picture
- Values: Different prioritization (speed vs quality, innovation vs stability, autonomy vs alignment)

**Distinctness Check:**
If two agents could swap personas and still make sense, they're TOO SIMILAR. Rewrite.

</distinctness_requirement>

<domain_expertise_requirement>

**CRITICAL: Domain expertise must be AUTHENTIC**

For domain experts and specialists:
- Use terminology from {{domain_context}}
- Reference challenges specific to {{domain}}
- Demonstrate understanding through identity and principles
- NOT surface-level ("knows about healthcare") but specific ("understands HIPAA compliance and patient safety dependencies")

</domain_expertise_requirement>

<store>
For each generated agent, store complete persona:
- name (agent-id format: lowercase-with-dashes)
- display_name (How they're referenced)
- title (Role title)
- icon (Emoji)
- type (entry-point or sub-agent)
- role (Role description)
- identity (Background & expertise)
- communication_style (How they communicate)
- principles (Values & philosophy)

Store all in {{generated_agents}} array
</store>

</step>

---

<step n="6" goal="Quality Check - Personas">

<action>
Before proceeding, verify persona quality.
</action>

<checks>

1. **Distinctness Check**
   - Read all agent communication styles
   - Do they sound dramatically different?
   - If >2 agents sound similar, revise those agents

2. **Domain Expertise Check**
   - Do domain expert agents use terminology from requirements?
   - Is expertise authentic or surface-level?
   - If surface-level, enhance with specific context

3. **Concern Coverage Check**
   - Is each key concern addressed by a specialist agent?
   - Are concern-specific agents' personas aligned with concern?
   - If gaps, add or revise agents

4. **Memorability Check**
   - Read each agent persona
   - Is it memorable? Would you remember this agent after reading once?
   - If forgettable, add personality markers and specific details

5. **Generic Language Check**
   - Search for generic phrases: "experienced professional", "professional and clear", "believes in quality"
   - If found, replace with specific alternatives

6. **Type Assignment Check**
   - Does each Entry-Point agent represent a primary user interaction point?
   - Are Sub-Agents truly supporting roles that work within workflows?
   - Is there at least 1 Entry-Point agent? (coordinator at minimum)

</checks>

<revision>
If any checks fail, revise agents before proceeding.
Quality at this stage determines final team quality.
</revision>

</step>

---

<step n="7" goal="Design Team Workflows">

<action>
Design workflows that Entry-Point agents will route to via their menus.
Each workflow becomes an actual set of files: workflow.yaml + instructions.md + template.md.
Workflows are processed by the BMAD workflow.xml engine which enforces checkpoints.
</action>

<workflow_design>

**Number of Workflows:**
- Simple teams (4-6 agents): 2-4 workflows total across all entry-point agents
- Medium teams (6-8 agents): 3-6 workflows
- Large teams (8-12 agents): 4-8 workflows

**Each Entry-Point agent should have 1-3 domain-specific workflow menu items.**
Standard menu items (MH, CH, SS, PM, DA) are always included automatically.

**Workflow Architecture (matching working BMAD patterns):**

Each workflow consists of:
```
_bmad/teams/{{team_name}}/workflows/{{workflow-name}}/
  â”œâ”€â”€ workflow.yaml      (config, paths, variables)
  â”œâ”€â”€ instructions.md    (step-by-step with <template-output> checkpoints)
  â””â”€â”€ template.md        (output document template)
```

Simple exec-style workflows (no template output) can be a single .md file:
```
_bmad/teams/{{team_name}}/workflows/{{workflow-name}}.md
```

</workflow_design>

<workflow_types>

**Workflow Types Based on Domain:**

**research-intelligence domain:**
- Comprehensive Research workflow (define scope â†’ search â†’ evaluate â†’ synthesize â†’ report)
- Quick Lookup workflow (single focused question â†’ search â†’ answer)

**planning-strategy domain:**
- Strategic Planning workflow (vision â†’ analysis â†’ options â†’ decision)
- Risk Assessment workflow (identify â†’ evaluate â†’ mitigate â†’ monitor)

**creative-content domain:**
- Content Creation workflow (ideation â†’ draft â†’ review â†’ optimize)
- Campaign Planning workflow (strategy â†’ channels â†’ content â†’ schedule)

**technical-development domain:**
- Feature Development workflow (design â†’ implement â†’ test â†’ deploy)
- Code Review workflow (load â†’ analyze â†’ report â†’ iterate)

**operations-support domain:**
- Incident Response workflow (detect â†’ diagnose â†’ resolve â†’ postmortem)
- Process Improvement workflow (measure â†’ analyze â†’ improve â†’ control)

**domain-specific-expert domain:**
- Domain-appropriate governance workflow
- Expert consultation workflow

</workflow_types>

<workflow_structure>

For each workflow, create:

**1. workflow.yaml** (configuration)
```yaml
name: "{{workflow-name}}"
description: "{{specific description}}"
config_source: "{project-root}/_bmad/teams/{{team_name}}/config.yaml"
output_folder: "{config_source}:output_folder"
user_name: "{config_source}:user_name"
communication_language: "{config_source}:communication_language"
date: system-generated
installed_path: "{project-root}/_bmad/teams/{{team_name}}/workflows/{{workflow-name}}"
template: "{installed_path}/template.md"
instructions: "{installed_path}/instructions.md"
default_output_file: "{output_folder}/{{workflow-name}}-{{date}}.md"
standalone: true
```

**2. instructions.md** (step-by-step process)
```xml
<workflow>
<critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
<critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
<critical>Communicate all responses in {communication_language}</critical>
<critical>CHECKPOINT PROTOCOL: After EVERY template-output tag: SAVE â†’ DISPLAY â†’ PRESENT [a/c/p/y] â†’ WAIT</critical>

<step n="1" goal="...">
  <ask>...</ask>
  <action>...</action>
  <template-output>...</template-output>
</step>

<!-- Domain-specific steps with checkpoints -->

<step n="final" goal="Review & Save Learnings">
  <action>Summarize what was accomplished</action>
  <ask>Did any tool tasks fail then succeed? Describe the working method.</ask>
  <check if="user reports a learned method">
    <action>Load memory-guide.md for classification rules</action>
    <action>Save to memory MCP with correct entity type</action>
  </check>
  <template-output>workflow_summary</template-output>
</step>
</workflow>
```

**3. template.md** (output document)
- Section headers matching template-output variables
- Placeholder markers for generated content
- Appropriate structure for the workflow's domain

</workflow_structure>

<workflow_quality>

**Each workflow MUST have:**
- Minimum 3 steps, maximum 10 steps
- A `<template-output>` checkpoint after every content-generating step
- Clear goal for each step
- `<ask>` tags for user interaction (never auto-proceed)
- A final "Review & Save Learnings" step (standard across all workflows)
- Reference to workflow.xml engine in critical directives

**Each workflow step MUST have:**
- Clear goal description
- Specific actions (not vague "gather information")
- User interaction points (questions, confirmations)
- Template-output save checkpoint

**Steps should reference Sub-Agents where appropriate:**
When a workflow step needs specialist expertise, reference the sub-agent:
```xml
<step n="3" goal="Risk Assessment">
  <action>Invoke {{risk-analyst-name}} perspective for risk evaluation</action>
  <action>Apply risk assessment framework from {{risk-analyst}} expertise</action>
</step>
```

</workflow_quality>

<critical>
Workflows MUST:
- Reference actual agent names from {{generated_agents}}
- Have actionable steps (not vague directives)
- Produce concrete outputs via template-output checkpoints
- Match {{workflow_preference}} style
- Align with {{collaboration_style}}
- Include tool-learning review as final step
- Be processable by the BMAD workflow.xml engine
</critical>

<store>
For each workflow, store:
- workflow name (kebab-case)
- which entry-point agent(s) it belongs to
- workflow.yaml content
- instructions.md content
- template.md content

Store all in {{generated_workflows}} array
Store count in {{workflow_count}}
</store>

</step>

---

<step n="8" goal="Define Collaboration Model">

<action>
Based on {{collaboration_style}}, define how this team works together.
</action>

<collaboration_models>

**formal:**
- Clear hierarchy with coordinator at top
- Formal handoffs between agents
- Document-driven processes
- Structured decision-making

**agile:**
- Sprint-based collaboration
- Daily standups (virtual)
- Retrospectives and planning sessions
- Iterative delivery

**consultative:**
- Multi-agent discussions
- Advisory interactions
- Collaborative decision-making
- Perspective-sharing model

**casual:**
- Flexible agent interactions
- Informal collaboration
- Ad-hoc teaming
- Exploratory approach

**flexible:**
- Balanced approach
- Adapts to context
- Mix of formal and informal

</collaboration_models>

<define>
For chosen {{collaboration_style}}, specify:
- How agents communicate
- When agents collaborate vs work independently
- How decisions are made
- What ceremonies or touchpoints exist (if any)
- How user interacts with team (single point of contact vs open access)

Store in {{collaboration_model}}
</define>

</step>

---

<step n="9" goal="Create Team Package">

<action>
Package all generated components into installable team structure.
This creates the complete set of files for the team.
</action>

<package_contents>

**1. Team Configuration (config.yaml)**
```yaml
team:
  name: "{{team_name}}"
  description: "{{team_description}}"
  version: "1.0"
  generated_date: "{{timestamp}}"

  domain: "{{domain}}"
  team_size: {{agent_count}}
  collaboration_style: "{{collaboration_style}}"

  agents:
    entry_point: [list of entry-point agent names]
    sub_agents: [list of sub-agent names]

  source:
    generated_by: "TeamBuilder v3.0"
    requirements_doc: "{{requirements_document}}"
    primary_pattern: "{{primary_pattern}}"

# Standard BMAD config variables
user_name: "{{user_name}}"
communication_language: "{{communication_language}}"
output_folder: "docs"
```

**2. Entry-Point Agent Files (Thin Shell)**

For each Entry-Point agent, create a thin shell file at:
```
_bmad/teams/{{team_name}}/agents/{{agent-id}}.md
```

**Structure matches working BMAD agents (architect.md pattern):**

```xml
<agent id="{{agent-id}}" name="{{display_name}}" title="{{title}}" icon="{{icon}}">

<activation critical="MANDATORY">
      <step n="1">Load persona from this current agent file (already in context)</step>
      <step n="2">ðŸš¨ IMMEDIATE ACTION REQUIRED - BEFORE ANY OUTPUT:
          - Load and read {project-root}/_bmad/teams/{{team_name}}/config.yaml NOW
          - Store ALL fields as session variables: {user_name}, {communication_language}, {output_folder}
          - VERIFY: If config not loaded, STOP and report error to user
          - DO NOT PROCEED to step 3 until config is successfully loaded and variables stored
      </step>
      <step n="3">Tool Inventory - Check what MCP tools are available:
          - Memory MCP? (search_nodes, create_entities, etc.)
          - Browser/Playwright MCP?
          - If TOOL_RECOMMENDATIONS.md exists at _bmad/teams/{{team_name}}/TOOL_RECOMMENDATIONS.md, read it
      </step>
      <step n="4">If memory MCP available: search_nodes for "{{team_name}}" and "general:" to load working methods</step>
      <step n="5">Check if _bmad/teams/{{team_name}}/session-context.md exists and has content.
          If yes: read it - this is project state from the previous session.</step>
      <step n="6">Show greeting:
          - If session context loaded: acknowledge with brief summary of where we left off
          - If no session context: normal in-character greeting using {user_name}
      </step>
      <step n="7">Display numbered list of ALL menu items from menu section</step>
      <step n="8">Let {user_name} know they can type `/bmad-help` at any time for advice</step>
      <step n="9">STOP and WAIT for user input - do NOT execute menu items automatically - accept number or cmd trigger or fuzzy command match</step>
      <step n="10">On user input: Number â†’ process menu item[n] | Text â†’ case-insensitive substring match | Multiple matches â†’ ask user to clarify | No match â†’ show "Not recognized"</step>
      <step n="11">When processing a menu item: Check menu-handlers section below - extract any attributes from the selected menu item (workflow, exec, action) and follow the corresponding handler instructions</step>

      <menu-handlers>
        <handlers>
          <handler type="exec">
            When menu item has exec="path/to/file.md":
            1. Read fully and follow the file at that path
            2. Process the complete file and follow all instructions within it
            3. If there is data="some/path/data.md" with the same item, pass that data path as context
          </handler>
          <handler type="workflow">
            When menu item has workflow="path/to/workflow.yaml":
            1. Load the workflow.xml runner from {project-root}/_bmad/core/tasks/workflow.xml
            2. Follow its instructions to process the workflow.yaml at the given path
          </handler>
        </handlers>
      </menu-handlers>

      <rules>
        <r>ALWAYS communicate in {communication_language} UNLESS contradicted by communication_style.</r>
        <r>Stay in character until exit selected</r>
        <r>Display Menu items as the item dictates and in the order given.</r>
        <r>Load files ONLY when executing a user chosen workflow or command, EXCEPTION: agent activation step 2 config.yaml</r>
      </rules>
</activation>

  <persona>
    <role>{{role}}</role>
    <identity>{{identity}}</identity>
    <communication_style>{{communication_style}}</communication_style>
    <principles>{{principles}}</principles>
  </persona>

  <menu>
    {{domain-specific menu items with workflow= or exec= attributes}}
    <item cmd="MH or fuzzy match on menu or help">[MH] Redisplay Menu Help</item>
    <item cmd="CH or fuzzy match on chat">[CH] Chat with the Agent about anything</item>
    <item cmd="SS or fuzzy match on save session" exec="{project-root}/_bmad/teams/{{team_name}}/workflows/_shared/save-session.md">[SS] Save session for next time</item>
    <item cmd="PM or fuzzy match on party-mode" exec="{project-root}/_bmad/core/workflows/party-mode/workflow.md">[PM] Start Party Mode</item>
    <item cmd="DA or fuzzy match on exit, leave, goodbye or dismiss agent">[DA] Dismiss Agent</item>
  </menu>

</agent>
```

**CRITICAL RULES for Entry-Point agents:**
- Agent file MUST be under 100 lines
- NO `<instructions>` section - task logic lives in workflow files
- NO `<working-methods>` section - lives in MCP memory
- NO `<memory-protocol>` section - lives in memory-guide.md
- NO `<working-methods-protocol>` section - handled by workflow checkpoints
- MUST have `<menu-handlers>` with exec and workflow handlers
- MUST have `<rules>` section (4 universal rules)
- Menu items MUST reference actual workflow/exec file paths

**3. Sub-Agent Files (Specialist)**

For each Sub-Agent, create a focused file at:
```
_bmad/teams/{{team_name}}/agents/{{agent-id}}.md
```

```xml
<agent id="{{agent-id}}" name="{{display_name}}" title="{{title}}" icon="{{icon}}">

  <persona>
    <role>{{role}}</role>
    <identity>{{identity}}</identity>
    <communication_style>{{communication_style}}</communication_style>
    <principles>{{principles}}</principles>
  </persona>

  <instructions>
  ## My Role as {{title}}

  {{Focused description of what this agent does within team workflows}}

  ## Domain Expertise

  {{Domain-specific knowledge, terminology, decision criteria}}

  ## How I Participate

  {{How this agent contributes when called from workflow steps}}
  {{Specific guidance for common tasks in this domain}}

  ## Quality Standards

  {{What "good work" looks like for this specialty}}
  </instructions>

</agent>
```

Sub-Agents are focused and domain-specific. Their instructions should be about their SPECIALTY, not generic protocol.

**4. Team Workflow Files**

For each workflow in {{generated_workflows}}, create the directory and files:
```
_bmad/teams/{{team_name}}/workflows/{{workflow-name}}/
  â”œâ”€â”€ workflow.yaml
  â”œâ”€â”€ instructions.md
  â””â”€â”€ template.md
```

Or for simple exec workflows:
```
_bmad/teams/{{team_name}}/workflows/{{workflow-name}}.md
```

Each workflow's instructions.md MUST:
- Reference the workflow.xml engine in `<critical>` directives
- Have steps with `<template-output>` checkpoints
- Include `<ask>` tags for user interaction (never auto-proceed)
- End with a "Review & Save Learnings" step
- Reference sub-agents where their expertise applies

**5. Shared Workflow Files**

Copy these standard files into every team:
```
_bmad/teams/{{team_name}}/workflows/_shared/
  â”œâ”€â”€ save-session.md       (session context save workflow)
  â””â”€â”€ tool-learning-review.md (reusable tool learning step)
```

Source templates at: `teambuilder/templates/shared-workflows/`

**6. Memory Guide**

Create the memory entity classification reference:
```
_bmad/teams/{{team_name}}/memory-guide.md
```

Source template at: `teambuilder/templates/shared-workflows/memory-guide.md`
Replace `{team-name}` with actual team name.

**7. Team README**

Create comprehensive team documentation:
```
_bmad/teams/{{team_name}}/TEAM_README.md
```

Including:
- Team purpose and overview
- Agent roster with roles and types (entry-point vs sub-agent)
- How to use the team (which agents to invoke)
- Available workflows per agent
- Collaboration model
- Tips for success

**8. Generation Summary**

Document generation details:
```
_bmad/teams/{{team_name}}/GENERATION_SUMMARY.md
```

Including:
- What was generated
- Requirements it addresses
- Agent type breakdown (entry-point vs sub-agent)
- Quality indicators
- Next steps (validation)

</package_contents>

<store>
Complete installation package in {{installation_package}}
</store>

</step>

---

<step n="10" goal="Register Team in BMAD Manifests">

<action>
Register the generated team in BMAD manifest files so Claude Code can discover and invoke the agents.
This step is CRITICAL - without it, users cannot invoke the team agents.
</action>

<manifest_registration>

**Why This Matters:**
Claude Code discovers available agents by reading `_bmad/_config/agent-manifest.csv`.
Without registration, the team exists in the filesystem but is invisible to invocation.

**Files to Update:**

1. **agent-manifest.csv** (`_bmad/_config/agent-manifest.csv`)

   For EACH agent in {{generated_agents}} (both entry-point AND sub-agent), append a row:
   ```csv
   "{{agent-id}}","{{display_name}}","{{title}}","{{icon}}","{{role_summary}}","{{identity_summary}}","{{communication_summary}}","{{principles_summary}}","teams:{{team_name}}","{{agent_file_path}}"
   ```

2. **manifest.yaml** (`_bmad/_config/manifest.yaml`)

   Add team to teams list:
   ```yaml
   teams:
     - {{team_name}}
   ```

   If `teams:` section doesn't exist, create it after `modules:` section.
   Also update `lastUpdated` timestamp.

</manifest_registration>

<implementation>

**Step-by-step registration process:**

1. Read current agent-manifest.csv
2. For each generated agent:
   - Extract summary fields from full persona
   - Format as CSV row with proper escaping (use &apos; for quotes in fields)
   - Append to CSV content
3. Write updated agent-manifest.csv

4. Read current manifest.yaml
5. Parse YAML structure
6. Add team name to teams list (create list if not exists)
7. Update lastUpdated timestamp
8. Write updated manifest.yaml

</implementation>

<verification>
After registration:
- Verify team name appears in manifest.yaml teams list
- Verify all {{agent_count}} agents appear in agent-manifest.csv
- Verify paths point to correct locations
</verification>

</step>

---

<step n="11" goal="Create Claude Code Command Stubs">

<action>
Create Claude Code command stub files so Entry-Point agents can be invoked via slash commands.
Only Entry-Point agents get command stubs - Sub-Agents are called from workflows, not directly.
</action>

<command_stub_structure>
For each **Entry-Point** agent in {{generated_agents}}, create a flat file at:
```
.claude/commands/bmad-agent-teams-{{team_name}}-{{agent-id}}.md
```

With this content:
```markdown
---
name: '{{agent-id}}'
description: '{{title}} - {{role_summary}}'
disable-model-invocation: true
---

You must fully embody this agent's persona and follow all activation instructions exactly as specified. NEVER break character until given an exit command.

IT IS CRITICAL THAT YOU FOLLOW THIS COMMAND: LOAD the FULL agent file from {project-root}/_bmad/teams/{{team_name}}/agents/{{agent-id}}.md, READ its entire contents - this contains the complete agent persona, activation sequence, menu, and handlers. Follow the <activation> section precisely.
```
</command_stub_structure>

<implementation>

**Step-by-step process:**

1. Ensure `.claude/commands/` directory exists

2. For each **Entry-Point** agent only:
   - Extract agent-id, title, and role summary
   - Generate stub content using template above
   - Write file to `.claude/commands/bmad-agent-teams-{{team_name}}-{{agent-id}}.md`

3. Verify all files created successfully

**Note:** Sub-Agents do NOT get command stubs. They participate in workflows but aren't directly invoked.

</implementation>

</step>

---

<step n="11b" goal="Create Party-Mode and Workflow Command Stubs">

<action>
Create Claude Code command stubs for the team's party-mode and workflows.
Without these, users cannot invoke team discussions or workflows via slash commands.
</action>

<party_mode_stub>
Create a party-mode command stub at:
```
.claude/commands/bmad-teams-{{team_name}}-party-mode.md
```

With this content:
```markdown
---
name: '{{team_name}}-party-mode'
description: '{{team_display_name}} studio session - All {{agent_count}} agents collaborate'
disable-model-invocation: true
---

IT IS CRITICAL THAT YOU FOLLOW THIS COMMAND:

## {{team_display_name}} Party Mode - Team Discussion

LOAD the party-mode workflow from {project-root}/_bmad/core/workflows/party-mode/workflow.md and follow its instructions.

Before starting, also:
1. LOAD the agent manifest from `{project-root}/_bmad/_config/agent-manifest.csv` and filter to `teams:{{team_name}}` agents
2. ONLY include agents from the {{team_name}} team in the discussion
3. This is a team-scoped party mode - do NOT include agents from other teams or modules
```
</party_mode_stub>

<workflow_stubs>
For EACH workflow in {{generated_workflows}} that has a workflow.yaml (full workflows, not simple exec files):

Create a command stub at:
```
.claude/commands/bmad-teams-{{team_name}}-{{workflow-name}}.md
```

With this content:
```markdown
---
name: '{{team_name}}-{{workflow-name}}'
description: '{{workflow_description}}'
disable-model-invocation: true
---

IT IS CRITICAL THAT YOU FOLLOW THIS COMMAND: LOAD the workflow.xml runner from {project-root}/_bmad/core/tasks/workflow.xml and use it to process the workflow at {project-root}/_bmad/teams/{{team_name}}/workflows/{{workflow-name}}/workflow.yaml
```
</workflow_stubs>

<verification>
After creating all stubs, verify:
- One agent stub per **Entry-Point** agent
- One party-mode stub
- One stub per full workflow
</verification>

</step>

---

<step n="12" goal="Handoff to Validation">

<action>
Pass generated team to validation workflow for quality assessment.
</action>

<handoff>
Trigger validate-team workflow with:
- {{generated_agents}} - All agent definitions (with types)
- {{generated_workflows}} - All workflow definitions
- {{team_name}} - Team identifier
- {{requirements_document}} - Original requirements
- {{installation_package}} - Complete package

Validation workflow will:
1. Run all validation checks
2. Calculate quality score
3. Generate validation report
4. Present to user with install/refine options
</handoff>

<user_message>
"Team generation complete! Now validating quality... (this takes about 30 seconds)"
</user_message>

</step>

---

## Quality Assurance During Generation

### Self-Checks Throughout Process

**After Step 5 (Persona Generation):**
- Are personas truly distinct or do some sound similar?
- Is domain expertise authentic or generic?
- Does each agent feel like a real person?

**After Step 7 (Workflow Design):**
- Do workflows have `<template-output>` checkpoints at every step?
- Do workflows reference the workflow.xml engine?
- Do workflows include tool-learning review as final step?
- Are workflow steps specific and actionable?

**After Step 9 (Team Package):**
- Are Entry-Point agent files under 100 lines? (thin shell check)
- Do Entry-Point agents have menu-handlers and rules?
- Do Entry-Point agents NOT have `<instructions>` sections?
- Do Sub-Agents have focused `<instructions>` sections?
- Do all menu items reference actual file paths?

**Before Step 12 (Handoff):**
- Does this team address user's {{primary_task}}?
- Are all {{key_concerns}} covered by specialists?
- Is {{required_expertise}} present?
- Does collaboration model match {{collaboration_style}}?

### Anti-Pattern Detection

Watch for and FIX these anti-patterns:

**Pattern Copying:** "I'll use the research strategist from the pattern"
FIX: Create new agent inspired by principles, not copied

**Generic Personas:** "Professional and experienced"
FIX: Add specific background and personality

**Fat Monolith Agents:** Entry-Point agent with `<instructions>`, `<working-methods>`, `<memory-protocol>`
FIX: Remove these sections. Task logic goes in workflow files. Memory/learning handled by workflow checkpoints.

**Workflows Without Checkpoints:** Steps that auto-proceed without `<template-output>`
FIX: Every content-generating step MUST have a checkpoint

**Similar Communication Styles:** Multiple agents "professional and clear"
FIX: Vary dramatically (formal, casual, technical, warm, etc.)

**Vague Workflow Steps:** "Step 1: Gather information"
FIX: "Step 1: Interview user about X, Y, Z specific aspects"

**Missing Concerns:** Key concern not addressed by any agent
FIX: Add specialist agent for that concern

---

## Generation Success Criteria

Generation succeeds when:

1. All agents have distinct, memorable personas
2. Domain expertise is authentic (uses terminology from requirements)
3. Every key concern is addressed by specialist agent
4. Collaboration model matches user preference
5. Entry-Point agents are thin shells (<100 lines) with menu + workflow delegation
6. Sub-Agents have focused instructions for their specialty
7. Workflows have step-by-step logic with template-output checkpoints
8. All workflows include tool-learning review as final step
9. Shared files (save-session, memory-guide) are included
10. Package is complete and installable

If ANY criterion is not met, REVISE before handoff to validation.

---

**Generation Complete â†’ Validation â†’ User Review â†’ Install or Refine**
